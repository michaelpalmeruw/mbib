% LaTeX documentation for mbib. It loads some of my personal packages;
% therefore, this documentation won't compile out of the box after
% cloning the repository. 


\documentclass[10pt]{article}

\usepackage[margin={0.5in,0.75in},papersize={7in,10in}]{geometry}
\usepackage[scale=0.92]{mybookfonts}
\usepackage{xspace,verbatim,graphicx,shortvrb}

\usepackage[small]{titlesec}
\setlength{\parindent}{2em}
\usepackage{simplehref, vf-plaindoc, setspace}
\setstretch{1.08}

\newcommand*{\mbib}{\texttt{mbib}\xspace}
\newcommand*{\jabref}{\texttt{JabRef}\xspace}
\newcommand*{\ooo}{\texttt{OOo}\xspace}
\newcommand*{\bibtex}{\texttt{BibTex}\xspace}
\newcommand*{\sqlite}{\texttt{SQLite}\xspace}
\newcommand*{\ini}{\texttt{.mbib.ini}\xspace}

\newcommand*{\key}[1]{\texttt{#1}\xspace}
\newcommand*{\arrowdown}{\key{$\downarrow$}}
\newcommand*{\arrowup}{\key{$\uparrow$}}

\newcommand{\screenshot}[2][]{%
\medskip\par
\begin{center}
\includegraphics[width=1300px,#1]{/data/code/mbib/docs/screenshots/#2}
\end{center}}

\MakeShortVerb{\~}

\begin{document}

\section*{\mbib Documentation}

\emph{As of \today, the tutorial is almost complete, but the reference section is still missing.}

\bigskip

\noindent \mbib is a literature manager, with capabilities similar to \href{http://www.jabref.org}{\jabref}, but intended to better cope with large databases that may contain thousands of references.  Key features and limitations are:

\begin{itemize}
\item Import from and export to \bibtex  

\item Import records from DOI and PubMed identifiers

\item Push citations to \texttt{Texmaker}/\texttt{TexStudio}

\item Push citations to OpenOffice.org/LibreOffice (collectively referred to as ``\ooo'' below). Formatting of bibliographies in \ooo piggybacks on \jabref. Thus, you need to have \jabref installed in order to fully use \mbib with \ooo.

\item Written in Python3.

\item Console-based GUI, based on the \texttt{urwid} and
\texttt{urwidtrees} Python libraries. 

\item Data are stored in a \sqlite database.

\item Developed and tested only on Linux, and will likely not work out of the box on other platforms. (Volunteers for porting it to other platforms are welcome.)

\end{itemize}

\section{Preliminary notes}

\subsection{Motivation}

I started writing \mbib after my previous literature manager (\texttt{bibus}) broke down because of growing incompatibilities with LibreOffice, wxPython etc. I tried using \jabref for a while, and while it's really pretty good in many ways, it bogs down once you have several thousand references in your database. (The same goes for Zotero and Mendeley.)


%The database has a fairy simple structure that lends itself to direct querying and manipulation with SQL
%
%Therefore, starting the program does \emph{not} load the entire database into memory. 

\subsection{Status}

At present, \mbib is alpha software. Incompatible changes will likely happen to the code and might happen to the database structure. However, in the latter case, I will provide a script for migrating the database to the new format (which I will have to do with my own database anyway). 

The program was written primarily with my own needs in mind. I work in biochemistry and use PubMed as my main online literature source, and I have therefore given interaction with that database priority. People in other fields might miss tighter integration with other databases. I'm open to adding support for those, but likely won't do so unless prodded. Similarly, some other bits of functionality are tailored to my own personal preferences and may seem a little narrow or idiosyncratic to others. Let me know if you need or want to contribute enhancements. 

The code violates all manner of software engineering gospel. There are no unit tests, and I don't plan to add them; the doc strings are a bit spotty and not formatted for automatic conversion into API docs. That said, I will give an overview of the program structure below, which hopefully will help you find your way through the code. 

\section{Installation}

In the following, I am going to describe how things work on \emph{my} system. I am running Debian with a KDE desktop. I don't suppose there will be any major differences with other Linux distros or window managers, but I am not going to verify this by experiment. If you manage to get it to work on other systems and have some specific tricks to share, please let me know,%
%
\footnote{mpalmeruw@gmail.com}
%
and I will include them here.

\subsection{Prerequisites}

In order to run \mbib, you first need to install these programs and libraries:

\begin{itemize}
\item Bash
\item Python3 
\item \sqlite
\item The \texttt{urwid} and \texttt{urwidtrees} libraries for Python3
\item If you intend to use \mbib with \ooo, you also need the \texttt{PyUNO} bridge for Python3, as well as \jabref
\item If you want to copy items to the X clipboard, you will need \texttt{xclip}
\item For viewing or emailing PDF files, \mbib relies on \texttt{xdg-open} and \texttt{xdg-email}
% anything else?
\end{itemize}

\noindent Bash is probably present on any Linux system by default. On Debian, all other prerequisites can be installed through the system's package manager. A copy of \sqlite already comes as part of the standard library when you install Python3, but you may also want to install the \texttt{sqlite3} package, which provides the command line client that lets you run SQL statements directly on your database. 

The \texttt{xdg-open} and \texttt{xdg-email} utilities may already be installed by default on your graphical Linux desktop; in Debian, they reside in the \texttt{xdg-utils} package.

\subsection{Installing \mbib}

Just clone (or download and unzip) the repository and add the main directory (\mbib) to your bash \texttt{\$PATH}. 

\subsection{Configuration}

The first program start will generate a configuration \ini file in your home directory. The available settings are explained in comments inside the file itself.%
%
\footnote{You can have multiple configuration files and select one on the command line. This is explained in section \dots}

\section{Tutorial}
\label{sec:tutorial}

Here we give an overview of the general work flow. We assume that the default configuration settings are in effect. A complete reference section describing all program features and configuration options will be added later. 

\subsection{Starting the program}

Assuming you have installed all prerequisites and added the \mbib directory to your shell's \texttt{\$PATH}, you should now be able to open a console window and run 

\begin{verbatim}
mpalmer@rehakles:~$ mbib.sh
\end{verbatim}

\noindent After the first start, the expected output should be 

\begin{verbatim}
Config file /home/mpalmer/.mbib.ini not found!
Create default configuration file and proceed (1) or exit (2)?
1) proceed
2) exit
#? 
\end{verbatim}

\noindent Press \key{1} and \key{Enter}, and you should see

\begin{verbatim}
#? 1
OK
Database file /home/mpalmer/mbib.sqlite not found. Create? (y/n) 
\end{verbatim}

\noindent Press \key{y} and the program should start. The interface should look like this:

\screenshot{initial-screen}

\noindent \mbib displays all references in a tree structure. The main \texttt{References} folder at this time has two sub-folders. Move between the displayed items using the arrow keys, the mouse wheel, or click directly on the desired folder. Go to the ``general interest'' folder and press \key{F2}. You should now see the references contained in this folder:

\screenshot{f2-pressed}

\noindent Pressing \key{F2} once more will close the folder again. However, for now leave it open, and use the arrow keys or the mouse again to highlight the record with the label  \texttt{Harrit2009} (which by the way also functions as its \bibtex key). 

\subsection{Working with references}

When \texttt{Harrit2009} is highlighted, press \key{Enter} (or use a double mouse click), and you should see this context menu:

\screenshot{reference-menu}

\noindent Navigate the menu using \arrowup, \arrowdown, and select an item with \key{Enter}, or alternatively use the indicated shortcut keys or a single mouse click. If we select \texttt{Show details}, the \texttt{View reference} dialog comes up:

\screenshot{refview}

\noindent Use the \arrowup/\arrowdown keys again to scroll through this dialog.  The abstract is at the bottom. Above it, there are up to three fields that are hyperlinks. The one currently in focus is highlighted in blue; you can activate it by pressing \key{Enter}) or again using the mouse, which will open a browser window and take you to the corresponding URL. 

Press \texttt{Esc} to close the dialog, and then \key{Enter} to reopen the menu. This time, choose \texttt{Edit details}. The dialog will look similar, but now the content of all fields is editable, and fields that are currently empty are displayed as well. Make some changes---for example, add a comment: ``That stuff they found in the dust must of been paint peeled off from them box cutters.'' Press \texttt{Tab} to switch to the buttons at the bottom; use the left and right arrow keys to select ``Cancel'' or ``OK'', and \key{Enter} to confirm or abort the edit.  

\subsection{Moving references around}
\label{sec:moving}

You might be disturbed by the scientific evidence that demonstrates the WTC towers were rigged with explosives and therefore want to delete this reference.%
%
\footnote{I would, however, suggest that you give it a look; it is a very solid paper, and as scientists we should go wherever the evidence leads us.}
%
Bring up the menu again and press \texttt{d} to delete the reference from this one folder, or \texttt{r} to also delete any copies residing in other folders (which in this case don't exist). After confirmation, the reference now shows up in the Trash folder:

\screenshot{harrit-trash}

\noindent Navigate down to the Trash folder and press \key{Enter} or double-click on it to bring up this folder's context menu:

\screenshot{trash-menu}

\noindent Selecting the ``Empty Trash'' option will get rid of the deleted reference entirely and irreversibly. However, for the purpose of this tutorial, use the ``Recycle'' option to move the deleted reference to the Recycled folder. Navigate to it and press the Space key to select it: 

\screenshot{harrit-recycled}

\noindent Let's assume that you plan to look at this paper some other time, and you want to collect such references in a separate folder. Navigate to the ``general interest'' folder and activate its menu (\key{Enter} or mouse double-click), then activate the option ``Add sub-folder'':%
%
\footnote{The folder context menu is quite long. In these screenshots, which use a small window, some items at the bottom are hidden. If such is case on your screen also, use the \arrowdown key to scroll them into view.}

\screenshot{folder-menu}

\noindent This will bring up a dialog that prompts you for the name for the new sub-folder. After entering ``read later'' and confirming, the display should look like this:

\screenshot{read-later}

\noindent The new folder has no $+$/$-$ switch before its name because it is still empty. To move the previously recycled reference into this folder, bring up the new folder's context menu and select the ``Move selected items here'' option:

\screenshot{move-here}

\noindent After completing this, you should now have the recycled reference in the new folder. (Use the \key{F2} key to display the folder's contents.)

Note that you can select more than one reference at a time; all of them will be copied or moved to a given destination. You can also select and then move or copy entire folders. As a practical exercise, create a folder named ``test'' directly below ``References''. Navigate back to ``general interest'' and select this folder with the space bar. Go back to ``test'', open its menu and select ``Copy selected items here''. 

You will now have cloned the entire folder with sub-folders and references. If you would rather have all those copied references directly underneath ``test'', without any intermediate sub-folders, open the menu for ``test'' again and select ``Flatten folder.'' This will give you the following result:

\screenshot{flatten-folder}

\noindent You will notice that the references in both ``test'' and ``general interest'' are highlighted in blue. This indicates that they are, by virtue of being contained in a selected folder somewhere in the tree (in this case the ``general interest'' folder), part of the currently active selection.%
%
\footnote{To be explicit about it: multiple instances of the same reference in different folders point to the same single instance of the reference in the database; this means that changes made to any instance will be shared by all others. That is, after all, what relational databases are good for.}
%
Deselecting ``general interest'' by hitting \key{Space} on it again will also deselect the references. 

\subsection{Importing references}

References can be imported using PubMed identifiers, DOI identifiers, and \bibtex text. We will start with PubMed. Go to the PubMed website (\url{https://www.ncbi.nlm.nih.gov/pubmed/}) and type the following into the search bar:

\begin{verbatim}
blue-native[ti] anal-biochem[so]
\end{verbatim}

This will give you (at the time of this writing) 16 results. Choose the ``PMID List'' option from the page's display format control to see the identifiers for these papers. Use your mouse to select some or all of them. 

In \mbib, create a new sub-folder ``blue-native'' within ``biochemistry''. Open its menu and choose ``Import references from PubMed''. Hold down the Shift key and middle-click your mouse%
%
\footnote{This behaviour is provided by the X environment, not implemented by \mbib; it seems possible to me that some desktop environments might modify it, but I don't know for sure.}
%
to paste the selected PMIDs from the clipboard into the dialog. Click OK to start the import. The references will be imported one by one, and a unique \bibtex key will be automatically generated from the first author's last name and the year of publication. 

Notice that the imported references will also show up in the ``Recently added'' folder at the top of the tree. This can be convenient for quicker access, since references newly imported into a folder don't float to the top; they just get sorted according to either year or \bibtex key (press \key{F7} to toggle) and thus may ``get lost in the crowd'' within a folder that already contains many references.

The procedure for importing references via DOI is similar to that for PubMed identifiers; if you have a list of such identifiers, separated by white space, you can just paste them. Alternatively, you can load both types of identifiers from a plain text file by specifying the file name; \mbib will first treat the input as a file name, and failing that will attempt to use the input directly. 
 
As an example for importing \bibtex, go to a paper on 
sciencedirect (for example \href{https://doi.org/10.1016/j.bbamem.2014.05.014}{this one}) and export the \bibtex record for it. Copy it into your clipboard by mouse-selecting it, or save it to file. Open ``Import references from BibTex'' from the folder menu and then paste the \bibtex text or give the file name. 

Pasting works fine for one or a handful of references;  be warned, however, that pasting longer text will be quite slow. In this case, it is better to first save the \bibtex to file, and then enter the file name into the \bibtex import dialogue. 

\subsection{Exporting references}

% To export individual folders to BibTex, select the appropriate item from their context menu. The same operation performed on the References folder will export the entire database. The exported file will be free of duplicates; you are free to keep copies of the same reference in as many folders as you wish. 

References can be exported to \bibtex or HTML. The formatting of the former can be fine-tuned through various settings in the \texttt{.mbib.ini} file; the latter, for the time being, cannot. Duplicates are weeded out; any folder trees are not preserved, that is, a flattened list of records is generated. 

The export operations are available in the context menu of the ``References'' folder, in which case the entire database is exported, as well as from the menu of each sub-folder, which will export the references within and below it. Additionally, export operations can also be applied to the currently selected references (including those residing in folders). Press \key{F5} to bring up a context menu that contains this and other operations pertaining to the current selection.

\subsection{Syncing \bibtex files to the database}

You can also export references from the command line, without opening an interactive \mbib session. In the simplest case, you can use 

\begin{verbatim}
mpalmer@rehakles:~$ mbib.sh -b sync
\end{verbatim}

\noindent This will export all references in the \mbib database to a \bibtex file, the path of which is configured in the \ini file. You can override these settings by passing additional options, for example 

\begin{verbatim}
mpalmer@rehakles:~$ mbib.sh -b sync -t myproject.bib -f myproject
\end{verbatim}

\noindent Now, only the references which, inside \mbib, are stored in the folder named ``myproject'' will be exported, and they will be saved in the file \texttt{myproject.bib}. This allows you to keep all your references in a single, central \mbib database, and at the same time use small, project-specific \bibtex files next to your multiple separate manuscripts. A few more points to note: 

\begin{itemize}
\item If you have multiple folders named ``myproject", they will all be exported to the same file. 

\item If you have empty spaces in your folder name, you need to enclose in quotes on the command line:

\begin{verbatim}
mpalmer@rehakles:~$ mbib.sh -b sync -t myproject.bib -f "my project"
\end{verbatim}

\item The \texttt{\mbib -b sync} command will only export the database if its time stamp is more recent than that on the \bibtex file (or if the latter does not yet exist, obviously). 

\end{itemize}

\noindent The last point means that it costs very little to run this command routinely during document compilation. For example, if you use \texttt{latexmk}, \texttt{rubber} or a similar build tool, you can add a \texttt{\mbib -b sync} rule to the build script, after which your document will always be compiled against the current state of the \mbib database.

\subsection{Searching and filtering}

Coming back to the interactive interface, one important task we have not touched upon is searching for references. Navigate to the ``Search'' folder, bring up its context menu, and select ``New search''. This will bring up an empty search mask. Into the \texttt{abstract} field, type ``synthesis'', and hit \texttt{OK}. You should now see the following screen:

\screenshot{search-results}

The search results have been appended to the ``Search'' folder. You can work with them the usual way---edit them, select, copy, and move them. You cannot delete them individually, because it would be inconsequential, as they are merely copies of references stored elsewhere. However, you can use ``Delete from all folders'', in which case they will show up in the Trash. 

\noindent If you bring up the details view for either record in the Search Folder, (using \key{F2}), you will see an ``also in'' entry that is a hyperlink. Following it will take you to the directory in which this record resides. 

You can modify your search by selecting ``Edit last search'' from the ``Search'' folder's context menu. If you fill in multiple fields at the same time, all constraints will be applied at the same time. You can also apply multiple constraints to a single field using boolean operators. For example, typing the phrase: ~respiratory || cytochrome && PAGE~ into the ``abstract'' field of the search mask will look for records that contain the words ``respiratory'' or ``cytochrome'', as well as ``PAGE'' in the abstract. We note the following points:

\begin{itemize}
\item ~||~ and ~&&~ represent the boolean \texttt{or} and \texttt{and} operators.
\item ~||~ takes precedence over (binds more strongly than) ~&&~. This deviates from convention in mathematics, but I find it more useful; in my experience, it effectively does away with the need for using brackets (which \mbib doesn't support at this time). You can, however, change it in the \ini file, if you value mathematical purity over practicality.
\end{itemize}

\noindent You can search only for references, not folders. You can, however, filter folders by name. Press \key{F9} to enter a word or phrase to search for. Any folder whose name contains the entered phrase, as well as its sub-folders, will be displayed, while all other regular folders (those below ``References'') will be hidden. Press \key{F10} to revert to the full display. 

\subsection{Viewing PDF files}

I don't have a practical exercise here, because the 

\subsection{Multiple databases}

One of my key objectives with \mbib was to organize all my references within in a single database. However, if you prefer, you can have multiple databases and select the one to use from the command line: 

\begin{verbatim}
mpalmer@rehakles:~$ mbib.sh -d my/wonderful/database.sqlite
\end{verbatim}

\begin{comment}
\section{Running \mbib}

The program runs inside a console window. Assuming you have put a start-up script into your shell's path, just open a shell window (e.g.\ \texttt{konsole} on KDE, or \texttt{xterm} on any X-based desktop) and run \texttt{mbib.sh}.

%First, the standard way, and then maybe the wrapper bash script. Also how to add it to the K Menu and the work-around for konsole - use xterm instead. Customization of xterm via the ~/.Xresources file and 
%
%xrdb -merge ~/.Xresources
%
%Leave it to others to contribute instructions on how to run it on other desktops. 




\subsection{The user interface}

\begin{itemize}
\item navigation (mouse, keyboard)
\item viewing and editing references
\item importing references
\item moving things around (using selections)
\item searching and filtering
\item using the clipboard (requires xclip)
\item 
\end{itemize}

\end{comment}

\section{Reference} 

This section will describe the functions, configuration, and code structure. 

\section{Some gotchas}

Here are some things to keep in mind. 

\begin{itemize}

%\item Item selections are stored in the database. Maybe we should offer a configuration option to deselect everything, just as we do with the ``recently added'' folder. Yes, we do that now. 

\item All changes to the data---imports, edits, deletions---are saved to the database immediately, and there is no undo function. (However, as discussed in section \ref{sec:moving}, deleted references can still be retrieved from the ``Trash'' folder.)

\item \mbib On a related note: \mbib, by default, writes a backup version of the \sqlite file (with the appended extension \texttt{.bak}) next to the current database. (You can disable automatic backups in the \ini file.)  \emph{The backup file gets overwritten at program start if it deviates from the current database file.} Therefore, if you want to revert to the backup file, exit \mbib and then replace the current database file with the backup file \emph{before} restarting \mbib.

% \item Moving selected items from search results: the search folder is basically a simple folder in the database. So, if items in this folder are selected and moved, the copies in the permanent folder stay where they are. this is discussed in the tutorial.

%We may think about an option to erase all other copies of a reference. Yes, we have that now. Or all selected references -- we don't have that yet. If we did have it, I guess we should offer a confirmation dialog that specifies the number of selected references.

\item All the special top-level folders are special and protected just inside \mbib, because specific operations are available and others excluded; in particular, they cannot be deleted, moved, or renamed. However, no such protective restrictions apply when working with the database using an \sqlite shell. 

Generally speaking, it is a good idea to make a safety backup copy of the database file before performing major surgery in SQL. 
\end{itemize}



\end{document}